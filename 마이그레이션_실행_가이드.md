# 데이터베이스 근본적 개선 마이그레이션 실행 가이드

## ⚠️ 중요 안내

**이 마이그레이션은 데이터베이스 구조를 근본적으로 변경합니다.**

### 변경 사항
- `public.users` 테이블 **완전 제거**
- `profiles.user_id` → `auth.users.id` **직접 참조**
- Instagram 정보를 profiles 테이블에 **통합**
- `instagram_id NOT NULL` 제약 → **NULL 허용**

## 📋 사전 점검사항

### 1. 백업 확인
- [x] 자동 백업 생성됨: `backup-1756056465361.json`
- [ ] Supabase Dashboard에서 수동 백업 추가 실행

### 2. 코드 수정 완료
- [x] `app/result/save/page.tsx` 새 구조로 수정 완료
- [x] auth.users 직접 참조로 변경
- [x] Instagram 정보 profiles 통합

### 3. 테스트 환경 검증
- [ ] 테스트 환경에서 마이그레이션 실행
- [ ] OAuth 플로우 전체 테스트
- [ ] 데이터 무결성 확인

## 🚀 마이그레이션 실행 단계

### Step 1: Supabase Dashboard 접속
```
URL: https://app.supabase.com/project/hvpyqchgimnzaotwztuy/editor
```

### Step 2: SQL Editor에서 실행
파일: `migration-1756056465362.sql`

**⚠️ 주의**: 한 번에 전체 실행하지 말고 단계별로 실행

#### 2.1 새 테이블 생성
```sql
-- 1단계: 새 profiles 테이블 생성
CREATE TABLE IF NOT EXISTS public.profiles_new (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
  -- ... 전체 구조
);
```

#### 2.2 데이터 마이그레이션
```sql
-- 2단계: 기존 데이터 복사 (3개 프로필)
INSERT INTO public.profiles_new (...) VALUES (...);
-- 각 프로필별로 개별 실행
```

#### 2.3 검증
```sql
-- 데이터 검증
SELECT COUNT(*) FROM public.profiles_new; -- 3개 예상
SELECT COUNT(*) FROM public.profiles; -- 3개 확인
```

#### 2.4 테이블 교체 (⚠️ 다운타임)
```sql
-- 주의: 이 단계에서 서비스 중단 발생
DROP TABLE public.profiles;
DROP TABLE public.users;
ALTER TABLE public.profiles_new RENAME TO profiles;
```

#### 2.5 인덱스 및 정책 재생성
```sql
-- 인덱스 생성
CREATE INDEX idx_profiles_user_id ON public.profiles(user_id);
-- RLS 정책 생성
-- ...
```

### Step 3: 검증
```sql
-- 최종 검증
SELECT 'auth.users' as table_name, COUNT(*) FROM auth.users
UNION ALL  
SELECT 'profiles', COUNT(*) FROM profiles;

-- 결과: 둘 다 3이어야 함
```

## 🧪 테스트 체크리스트

### 기능 테스트
- [ ] 새 사용자 소셜 로그인
- [ ] 프로필 자동 생성
- [ ] 기존 사용자 로그인
- [ ] 결과 페이지 접근
- [ ] Instagram 정보 저장/조회

### 데이터 무결성
- [ ] auth.users와 profiles 수 일치
- [ ] 고아 레코드 없음
- [ ] Foreign Key 제약 정상 작동
- [ ] Instagram ID NULL 값 허용

## 🚨 롤백 계획 (문제 발생 시)

### 긴급 롤백
```sql
-- 1. 새 테이블 제거
DROP TABLE IF EXISTS public.profiles;

-- 2. 백업에서 복원 (수동)
-- backup-1756056465361.json 데이터 사용
-- public.users, profiles 테이블 재생성

-- 3. 코드 롤백
git revert [커밋해시]
```

### 복구 절차
1. 서비스 점검 모드 전환
2. 백업 데이터 복원
3. 이전 코드로 롤백
4. 기능 확인 후 서비스 재개

## 📞 비상 연락

마이그레이션 중 문제 발생 시:
1. **즉시 중단**하고 현재 상태 백업
2. 롤백 계획 실행
3. 문제 상황 문서화

## ✅ 성공 기준

### 마이그레이션 성공 조건
- [ ] auth.users: 3명
- [ ] profiles: 3명  
- [ ] public.users 테이블 완전 제거
- [ ] 모든 OAuth 플로우 정상 작동
- [ ] 기존 사용자 데이터 보존
- [ ] 신규 가입 정상 처리

### 품질 기준
- [ ] 응답 속도 기존 대비 동일 이상
- [ ] 메모리 사용량 감소 (테이블 통합 효과)
- [ ] 에러 로그 없음
- [ ] 데이터 일관성 100%

---

**🎯 이 마이그레이션의 목표**
임시 우회책을 제거하고 올바른 단일 테이블 구조로 근본적 해결